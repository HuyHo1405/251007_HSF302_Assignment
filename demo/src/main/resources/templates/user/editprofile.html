<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/base :: head('Chỉnh sửa thông tin')}"></head>
<body th:replace="~{layout/base :: layout(~{::content}, 'Chỉnh sửa thông tin cá nhân', 'Cập nhật dữ liệu hồ sơ và thông tin liên hệ')}">
<main th:fragment="content">
    <div class="glass-card mx-auto" style="max-width: 720px;">
        <div class="d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-start gap-3 mb-4">
            <div>
                <h2 class="mb-1"><i class="bi bi-pencil-square me-2"></i>Chỉnh sửa thông tin</h2>
                <p class="text-secondary mb-0">Điền đầy đủ các trường để cập nhật hồ sơ của bạn</p>
            </div>
            <div class="chip">
                <i class="bi bi-person-badge"></i>
                <span th:text="${currentUser != null ? currentUser.username : '---'}">username</span>
            </div>
        </div>

        <div th:if="${success}" class="alert-glass mb-3" role="alert">
            <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="alert-glass alert-danger mb-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
        </div>

        <form th:action="@{/users/profile/edit}" method="post" th:object="${updateProfile}" class="row g-3">
            <div class="col-12">
                <label for="fullName" class="form-label">
                    <i class="bi bi-person me-1"></i>Họ và tên
                </label>
                <input type="text"
                       class="form-control"
                       id="fullName"
                       th:field="*{fullName}"
                       th:classappend="${#fields.hasErrors('fullName')} ? ' is-invalid' : ''"
                       placeholder="Nhập họ tên đầy đủ"
                       required>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></div>
            </div>

            <div class="col-12">
                <label for="emailAddress" class="form-label">
                    <i class="bi bi-envelope me-1"></i>Email
                </label>
                <input type="email"
                       class="form-control"
                       id="emailAddress"
                       th:field="*{emailAddress}"
                       th:classappend="${#fields.hasErrors('emailAddress')} ? ' is-invalid' : ''"
                       placeholder="example@email.com"
                       required>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('emailAddress')}" th:errors="*{emailAddress}"></div>
            </div>

            <div class="col-12">
                <label for="phoneNumber" class="form-label">
                    <i class="bi bi-telephone me-1"></i>Số điện thoại
                </label>
                <input type="text"
                       class="form-control"
                       id="phoneNumber"
                       th:field="*{phoneNumber}"
                       th:classappend="${#fields.hasErrors('phoneNumber')} ? ' is-invalid' : ''"
                       placeholder="Nhập số điện thoại liên hệ"
                       required>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('phoneNumber')}" th:errors="*{phoneNumber}"></div>
            </div>

            <!-- Địa chỉ -->
            <div class="col-12">
                <label class="form-label"><i class="bi bi-geo-alt me-1"></i>Địa chỉ</label>

                <!-- Tỉnh/Thành phố -->
                <div class="mb-2">
                    <select class="form-select" id="province" th:field="*{province}" th:classappend="${#fields.hasErrors('province')} ? ' is-invalid' : ''" required>
                        <option value="">-- Chọn Tỉnh/Thành phố --</option>
                    </select>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('province')}" th:errors="*{province}"></div>
                </div>

                <!-- Quận/Huyện -->
                <div class="mb-2">
                    <select class="form-select" id="district" th:field="*{district}" th:classappend="${#fields.hasErrors('district')} ? ' is-invalid' : ''" required disabled>
                        <option value="">-- Chọn Quận/Huyện --</option>
                    </select>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('district')}" th:errors="*{district}"></div>
                </div>

                <!-- Phường/Xã -->
                <div class="mb-2">
                    <select class="form-select" id="ward" th:field="*{ward}" th:classappend="${#fields.hasErrors('ward')} ? ' is-invalid' : ''" required disabled>
                        <option value="">-- Chọn Phường/Xã --</option>
                    </select>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('ward')}" th:errors="*{ward}"></div>
                </div>

                <!-- Địa chỉ chi tiết -->
                <div class="input-group">
                    <span class="input-group-text bg-transparent text-info"><i class="bi bi-house"></i></span>
                    <input type="text" class="form-control" id="addressDetail" th:field="*{addressDetail}" th:classappend="${#fields.hasErrors('addressDetail')} ? ' is-invalid' : ''" placeholder="Số nhà, tên đường..." required>
                </div>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('addressDetail')}" th:errors="*{addressDetail}"></div>
            </div>

            <div class="d-flex flex-column flex-md-row gap-3 mt-4">
                <button type="submit" class="btn-primary d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-save"></i> Lưu thay đổi
                </button>
                <a href="/users/profile" class="btn-secondary d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-x-circle"></i> Hủy bỏ
                </a>
            </div>
        </form>
    </div>
    <script th:inline="javascript">
        // Lấy giá trị đã chọn từ server (Thymeleaf)
        const selectedProvince = /*[[${updateProfile.province}]]*/ '';
        const selectedDistrict = /*[[${updateProfile.district}]]*/ '';
        const selectedWard = /*[[${updateProfile.ward}]]*/ '';

        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const wardSelect = document.getElementById('ward');

        let provinces = [];
        let provinceCodeMap = new Map(); // Map để lưu tên -> code

        // Load Tỉnh/Thành phố từ API
        async function loadProvinces() {
            try {
                const response = await fetch('https://provinces.open-api.vn/api/p/');
                provinces = await response.json();

                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.name;
                    option.textContent = province.name;
                    option.dataset.code = province.code;

                    // Pre-select nếu trùng với giá trị cũ
                    if (province.name === selectedProvince) {
                        option.selected = true;
                    }

                    provinceSelect.appendChild(option);
                    provinceCodeMap.set(province.name, province.code);
                });

                // Nếu có dữ liệu cũ, tự động load districts
                if (selectedProvince) {
                    const provinceCode = provinceCodeMap.get(selectedProvince);
                    if (provinceCode) {
                        await loadDistricts(provinceCode, selectedProvince);
                    }
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
                alert('Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại!');
            }
        }

        // Load Quận/Huyện từ API
        async function loadDistricts(provinceCode, provinceName) {
            try {
                districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
                wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
                wardSelect.disabled = true;

                const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const data = await response.json();

                let districtCodeMap = new Map();

                data.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.name;
                    option.textContent = district.name;
                    option.dataset.code = district.code;

                    // Pre-select nếu trùng với giá trị cũ
                    if (district.name === selectedDistrict && provinceName === selectedProvince) {
                        option.selected = true;
                    }

                    districtSelect.appendChild(option);
                    districtCodeMap.set(district.name, district.code);
                });

                districtSelect.disabled = false;

                // Nếu có dữ liệu cũ, tự động load wards
                if (selectedDistrict && provinceName === selectedProvince) {
                    const districtCode = districtCodeMap.get(selectedDistrict);
                    if (districtCode) {
                        await loadWards(districtCode);
                    }
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                alert('Không thể tải danh sách quận/huyện. Vui lòng thử lại!');
            }
        }

        // Load Phường/Xã từ API
        async function loadWards(districtCode) {
            try {
                wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';

                const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                const data = await response.json();

                data.wards.forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward.name;
                    option.textContent = ward.name;

                    // Pre-select nếu trùng với giá trị cũ
                    if (ward.name === selectedWard) {
                        option.selected = true;
                    }

                    wardSelect.appendChild(option);
                });

                wardSelect.disabled = false;
            } catch (error) {
                console.error('Error loading wards:', error);
                alert('Không thể tải danh sách phường/xã. Vui lòng thử lại!');
            }
        }

        // Event: Khi chọn Tỉnh/Thành phố
        provinceSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const provinceCode = selectedOption.dataset.code;

            if (provinceCode) {
                loadDistricts(provinceCode, this.value);
            } else {
                districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
                districtSelect.disabled = true;
                wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
                wardSelect.disabled = true;
            }
        });

        // Event: Khi chọn Quận/Huyện
        districtSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const districtCode = selectedOption.dataset.code;

            if (districtCode) {
                loadWards(districtCode);
            } else {
                wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
                wardSelect.disabled = true;
            }
        });

        // Khởi tạo khi trang load
        loadProvinces();
    </script>
</main>
</body>
</html>