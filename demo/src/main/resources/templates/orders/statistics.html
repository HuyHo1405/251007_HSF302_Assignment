<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/base :: head('Thống kê đơn hàng')}"></head>
<body th:replace="~{layout/base :: layout(~{::content}, 'Thống kê đơn hàng', 'Tổng quan doanh thu và tình trạng đơn hàng')}">
<main th:fragment="content">
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }

        .chart-card {
            box-sizing: border-box;
            height: 400px;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        .chart-card h5 {
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .chart-card canvas {
            flex: 1;
            max-height: 320px !important;
            width: 100% !important;
            height: 100% !important;
        }
    </style>

    <div class="glass-card">
        <div class="summary-grid mb-4">
            <div class="summary-item">
                <h4><i class="bi bi-cash-stack me-2"></i>Tổng doanh thu</h4>
                <p class="display-6 fw-semibold text-info mb-1" th:text="${totalRevenue != null ? #numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT') + ' vnđ' : '0 vnđ'}">0 ₫</p>
                <p class="text-secondary mb-0">Chỉ tính đơn hàng đã giao</p>
            </div>
            <div class="summary-item">
                <h4><i class="bi bi-check2-circle me-2"></i>Đơn hoàn thành</h4>
                <p class="display-6 fw-semibold text-success mb-1" th:text="${completedOrders != null ? completedOrders : 0}">0</p>
                <p class="text-secondary mb-0">Đơn giao thành công</p>
            </div>
            <div class="summary-item">
                <h4><i class="bi bi-hourglass-split me-2"></i>Đơn đang xử lý</h4>
                <p class="display-6 fw-semibold text-warning mb-1" th:text="${pendingOrders != null ? pendingOrders : 0}">0</p>
                <p class="text-secondary mb-0">Chưa hoàn thành</p>
            </div>
            <div class="summary-item">
                <h4><i class="bi bi-box-seam me-2"></i>Tổng đơn hàng</h4>
                <p class="display-6 fw-semibold text-info mb-1" th:text="${totalOrders != null ? totalOrders : 0}">0</p>
                <p class="text-secondary mb-0">Tất cả đơn đã tạo</p>
            </div>
        </div>

        <div class="analytics-grid mb-4">
            <div class="chart-card">
                <h5 class="chart-title"><i class="bi bi-pie-chart me-2"></i>Trạng thái đơn hàng</h5>
                <canvas id="orderStatusChart"></canvas>
            </div>
            <div class="chart-card">
                <h5 class="chart-title"><i class="bi bi-bar-chart me-2"></i>Doanh thu 6 tháng gần nhất</h5>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="glass-card">
            <h5 class="chart-title mb-3"><i class="bi bi-list-check me-2"></i>Đơn hàng gần đây</h5>
            <div class="table-responsive">
                <table class="table-glass">
                    <thead>
                    <tr>
                        <th>Mã đơn</th>
                        <th>Khách hàng</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="order : ${recentOrders}" th:if="${recentOrders != null}">
                        <td><a th:href="@{/orders/{id}(id=${order.id})}" th:text="'#' + ${order.id}">#1</a></td>
                        <td th:text="${order.userFullName}">Khách hàng</td>
                        <td th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</td>
                        <td>
                            <span class="status-badge"
                                  th:classappend="${order.status != null ? ' status-' + #strings.toLowerCase(order.status) : ''}"
                                  th:text="${order.status != null ? order.status : 'N/A'}">Status</span>
                        </td>
                        <td th:text="${order.createdAt != null ? order.createdAt : '---'}">01/01/2025</td>
                    </tr>
                    <tr th:if="${recentOrders == null || #lists.isEmpty(recentOrders)}">
                        <td colspan="5" class="text-center text-secondary">Chưa có đơn hàng nào</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script th:inline="javascript">
            const statusCtx = document.getElementById('orderStatusChart');
            if (statusCtx) {
                const statusCounts = /*[[${statusCounts}]]*/ {};
                const statusData = {
                    pending: statusCounts['PENDING'] || statusCounts['pending'] || 0,
                    paid: statusCounts['PAID'] || statusCounts['paid'] || 0,
                    shipping: statusCounts['SHIPPING'] || statusCounts['shipping'] || 0,
                    delivered: statusCounts['DELIVERED'] || statusCounts['delivered'] || 0,
                    cancelled: statusCounts['CANCELLED'] || statusCounts['cancelled'] || 0
                };
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Chờ xử lý', 'Đã thanh toán', 'Đang giao', 'Đã giao', 'Đã hủy'],
                        datasets: [{
                            data: [statusData.pending, statusData.paid, statusData.shipping, statusData.delivered, statusData.cancelled],
                            backgroundColor: ['#0ea5e9', '#f59e0b', '#cbd5f5', '#f8fafc', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                const monthlyRevenue = /*[[${monthlyRevenue}]]*/ [0, 0, 0, 0, 0, 0];
                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'],
                        datasets: [{
                            label: 'Doanh thu',
                            data: monthlyRevenue,
                            borderColor: 'rgba(14, 165, 233, 1)',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: 'rgba(14, 165, 233, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 12
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(148, 163, 184, 0.1)' },
                                ticks: {
                                    color: '#94a3b8',
                                    callback: v => v.toLocaleString('vi-VN') + '₫'
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }

        </script>
    </th:block>
</main>
</body>
</html>