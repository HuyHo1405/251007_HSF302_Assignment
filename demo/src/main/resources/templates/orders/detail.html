<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/base :: head('Chi tiết đơn hàng')}"></head>
<body th:replace="~{layout/base :: layout(~{::content}, 'Chi tiết đơn hàng', 'Kiểm tra thông tin và lịch sử giao dịch của đơn hàng')}">
<main th:fragment="content">
    <div class="glass-card mb-4" th:if="${order != null}">
        <div class="d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-start gap-3">
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-receipt-cutoff me-2"></i>
                    Đơn hàng #<span th:text="${order.id}">0</span>
                </h2>
                <p class="text-secondary mb-2">Khách hàng: <strong th:text="${order.userFullName}">Nguyễn Văn A</strong></p>
                <div class="list-inline">
                    <li>
                        <i class="bi bi-calendar-event"></i>
                        <span th:text="${order.createdAt != null ? order.createdAt : 'Chưa cập nhật'}"></span>
                    </li>
                    <li>
                        <i class="bi bi-geo-alt"></i>
                        <span th:text="${order.shippingAddress != null ? order.shippingAddress : 'Chưa có địa chỉ'}"></span>
                    </li>
                </div>
            </div>
            <div class="d-flex flex-column align-items-lg-end gap-2">
                <span class="status-badge"
                      th:classappend="${order.status != null ? ' status-' + #strings.toLowerCase(order.status) : ''}"
                      th:text="${order.status != null ? order.status.toUpperCase() : 'N/A'}">PENDING</span>
                <div class="chip">
                    <i class="bi bi-cash-stack"></i>
                    Tổng tiền:
                    <strong th:text="${order.totalPrice != null ? #numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">0 ₫</strong>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${order == null}" class="alert-glass alert-danger">
        <i class="bi bi-exclamation-triangle"></i> Không tìm thấy thông tin đơn hàng.
    </div>

    <div class="summary-grid" th:if="${order != null}">
        <div class="summary-item">
            <h4><i class="bi bi-person-vcard me-2"></i>Thông tin khách hàng</h4>
            <p class="mb-1"><strong>Họ tên:</strong> <span th:text="${order.userFullName}">---</span></p>
            <p class="mb-1"><strong>Số điện thoại:</strong> <span th:text="${order.userPhoneNumber != null ? order.userPhoneNumber : 'Chưa cập nhật'}"></span></p>
            <p class="mb-0"><strong>Email:</strong> <span th:text="${order.userEmail != null ? order.userEmail : 'Chưa cập nhật'}"></span></p>
        </div>
        <div class="summary-item">
            <h4><i class="bi bi-truck me-2"></i>Vận chuyển</h4>
            <p class="mb-1"><strong>Trạng thái:</strong> <span th:text="${order.status != null ? order.status.toUpperCase() : 'N/A'}"></span></p>
            <p class="mb-1"><strong>Địa chỉ giao:</strong> <span th:text="${order.shippingAddress != null ? order.shippingAddress : 'Chưa có địa chỉ'}"></span></p>
            <p class="mb-0"><strong>Cập nhật gần nhất:</strong> <span th:text="${order.updatedAt != null ? order.updatedAt : '---'}"></span></p>
        </div>
        <div class="summary-item">
            <h4><i class="bi bi-collection me-2"></i>Tổng quan</h4>
            <p class="mb-1"><strong>Số sản phẩm:</strong> <span th:text="${items != null ? items.size() : 0}">0</span></p>
            <p class="mb-1"><strong>Đã thanh toán:</strong> <span th:text="${payments != null ? payments.size() : 0}">0</span> giao dịch</p>
            <p class="mb-0"><strong>Trạng thái thanh toán:</strong> <span th:text="${order.paymentStatus != null ? order.paymentStatus : 'Chưa xác định'}"></span></p>
        </div>
    </div>

    <section class="mt-5">
        <h3 class="mb-3">
            <i class="bi bi-box-seam me-2"></i>Sản phẩm trong đơn hàng
        </h3>

        <div th:if="${items != null and not #lists.isEmpty(items)}" class="table-responsive">
            <table class="table-glass">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Tên sản phẩm</th>
                    <th>Đơn giá</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                </tr>
                </thead>
                <tbody>
                <!-- Danh sách sản phẩm -->
                <tr th:each="item, iterStat : ${items}">
                    <td th:text="${iterStat.count}">1</td>
                    <td th:text="${item.productName}">Laptop</td>
                    <td th:text="${item.unitPrice != null ? #numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}"></td>
                    <td th:text="${item.quantity}"></td>
                    <td th:text="${item.subtotal != null ? #numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}"></td>
                </tr>

                <!-- Tính tổng tiền sản phẩm (subtotal) -->
                <tr style="border-top: 2px solid rgba(255,255,255,0.1);">
                    <td colspan="4" class="text-end"><strong>Phí vận chuyển</strong></td>
                    <td>
                        <strong th:text="${order.shippingFee != null ? #numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT') + ' ₫' : '30,000 ₫'}">30,000 ₫</strong>
                    </td>
                </tr>

                <!-- Hàng tổng cộng -->
                <tr style="background: rgba(13, 110, 253, 0.1); border-top: 2px solid rgba(13, 110, 253, 0.3);">
                    <td colspan="4" class="text-end"><strong style="font-size: 1.1em;">Tổng</strong></td>
                    <td>
                        <strong style="font-size: 1.1em; color: #0d6efd;"
                                th:text="${order.totalPrice != null ? #numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">0 ₫</strong>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${items == null or #lists.isEmpty(items)}" class="alert-glass alert-danger">
            <i class="bi bi-exclamation-circle"></i> Đơn hàng chưa có sản phẩm nào.
        </div>
    </section>

    <section class="mt-5" th:if="${payments != null and not #lists.isEmpty(payments)}">
        <h3 class="mb-3"><i class="bi bi-credit-card me-2"></i>Lịch sử thanh toán</h3>
        <div class="table-responsive">
            <table class="table-glass">
                <thead>
                <tr>
                    <th>Mã giao dịch</th>
                    <th>Phương thức</th>
                    <th>Số tiền</th>
                    <th>Trạng thái</th>
                    <th>Thời gian</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="payment : ${payments}">
                    <td th:text="${payment.orderCode}">PAY001</td>
                    <td th:text="${payment.paymentMethod != null ? payment.paymentMethod : '---'}">VNPAY</td>
                    <td th:text="${payment.amount != null ? #numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}"></td>
                    <td>
                        <span class="status-badge"
                              th:classappend="${payment.status != null and payment.status.equalsIgnoreCase('successful') ? ' status-delivered' : ' status-pending'}"
                              th:text="${payment.status != null ? payment.status : '---'}">SUCCESS</span>
                    </td>
                    <td th:text="${payment.paidAt != null ? #temporals.format(payment.paidAt, 'dd/MM/yyyy HH:mm') : '---'}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section class="mt-5" sec:authorize="hasAnyRole('ADMIN','STAFF')" th:if="${order != null}">
        <h3 class="mb-3"><i class="bi bi-arrow-repeat me-2"></i>Cập nhật trạng thái</h3>
        <div class="glass-card">
            <form th:action="@{/orders/{id}/status(id=${order.id})}" method="post" class="row g-3 align-items-end">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="col-lg-8">
                    <label class="form-label">Trạng thái mới</label>
                    <select class="form-select" name="status" required>
                        <option value="CONFIRMED" th:selected="${order.status == 'confirmed' or order.status == 'CONFIRMED'}">Confirmed</option>
                        <option value="PAID" th:selected="${order.status == 'paid' or order.status == 'PAID'}">Paid</option>
                        <option value="SHIPPING" th:selected="${order.status == 'shipping' or order.status == 'SHIPPING'}">Shipping</option>
                        <option value="DELIVERED" th:selected="${order.status == 'delivered' or order.status == 'DELIVERED'}">Delivered</option>
                        <option value="CANCELLED" th:selected="${order.status == 'cancelled' or order.status == 'CANCELLED'}">Cancelled</option>
                    </select>
                </div>
                <div class="col-lg-4">
                    <button type="submit" class="btn-primary w-100 justify-content-center">
                        <i class="bi bi-save"></i> Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </section>

    <div class="d-flex flex-wrap gap-3 mt-5" th:if="${order != null}">
        <a href="/orders" class="btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại danh sách
        </a>
        <a th:if="${!#strings.equalsIgnoreCase(order.status, 'PAID')}"
           sec:authorize="hasRole('CUSTOMER')"
           th:href="@{/payments/create/{id}(id=${order.id})}"
           class="btn-primary">
            <i class="bi bi-credit-card"></i> Thanh toán ngay
        </a>
    </div>
</main>
</body>
</html>