<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head('Chọn phương thức thanh toán')}"></head>
<body th:replace="~{layout/base :: layout(~{::content}, 'Thanh toán đơn hàng', 'Hoàn tất đơn hàng với phương thức phù hợp')}">
<main th:fragment="content">
    <div th:if="${order != null}">
        <div class="glass-card mb-4 d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center gap-3">
            <div>
                <div class="chip mb-2">
                    <i class="bi bi-hash"></i>
                    Mã đơn <strong th:text="${order.id}">0</strong>
                </div>
                <h2 class="mb-1">Thanh toán đơn hàng #<span th:text="${order.id}">0</span></h2>
                <p class="text-secondary mb-0">Khách hàng: <strong th:text="${order.user != null ? order.user.fullName : (order.userFullName != null ? order.userFullName : '---')}">---</strong></p>
            </div>
            <div class="text-lg-end">
                <span class="status-badge"
                      th:classappend="${order.status != null ? ' status-' + #strings.toLowerCase(order.status) : ''}"
                      th:text="${order.status != null ? order.status : 'N/A'}">PENDING</span>
                <div class="mt-2 fw-semibold text-info">
                    Tổng thanh toán: <span th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                </div>
            </div>
        </div>

        <div class="summary-grid mb-5">
            <div class="summary-item">
                <h4><i class="bi bi-calendar-event me-2"></i>Thông tin chung</h4>
                <p class="mb-1"><strong>Ngày tạo:</strong> <span th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm') : '---'}"></span></p>
                <p class="mb-1"><strong>Địa chỉ giao:</strong> <span th:text="${order.shippingAddress != null ? order.shippingAddress : 'Chưa cập nhật'}"></span></p>
                <p class="mb-0"><strong>Số sản phẩm:</strong> <span th:text="${order.orderItems != null ? order.orderItems.size() : 0}"></span></p>
            </div>
            <div class="summary-item">
                <h4><i class="bi bi-cash-stack me-2"></i>Tóm tắt thanh toán</h4>
                <!-- Tính tổng tiền sản phẩm (tạm tính) -->
                <p class="mb-1" th:with="shippingFee=${order.shippingFee != null ? order.shippingFee : 30000},
                         subtotal=${order.totalPrice - shippingFee}">
                    <strong>Tạm tính:</strong> <span th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                </p>
                <p class="mb-1">
                    <strong>Phí vận chuyển:</strong>
                    <span th:text="${order.shippingFee != null ? #numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT') + ' ₫' : '30,000 ₫'}">30,000 ₫</span>
                </p>
                <p class="mb-0">
                    <strong>Tổng thanh toán:</strong>
                    <span th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                </p>
            </div>
        </div>

        <section class="mb-5">
            <h3 class="mb-3"><i class="bi bi-box-seam me-2"></i>Chi tiết sản phẩm</h3>
            <div class="table-responsive">
                <table class="table-glass">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Danh sách sản phẩm -->
                    <tr th:each="item, iterStat : ${order.orderItems}">
                        <td th:text="${iterStat.count}">1</td>
                        <td th:text="${item.product != null ? item.product.name : 'Sản phẩm'}">Laptop</td>
                        <td th:text="${item.quantity}"></td>
                        <td th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                        <td th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                    </tr>

                    <!-- Hàng phí vận chuyển -->
                    <tr style="border-top: 2px solid rgba(255,255,255,0.1);">
                        <td colspan="4" class="text-end"><strong>Phí vận chuyển</strong></td>
                        <td>
                            <strong th:text="${order.shippingFee != null ? #numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT') + ' ₫' : '30,000 ₫'}">30,000 ₫</strong>
                        </td>
                    </tr>

                    <!-- Hàng tổng cộng -->
                    <tr style="background: rgba(13, 110, 253, 0.1); border-top: 2px solid rgba(13, 110, 253, 0.3);">
                        <td colspan="4" class="text-end"><strong style="font-size: 1.1em;">Tổng</strong></td>
                        <td>
                            <strong style="font-size: 1.1em; color: #0d6efd;"
                                    th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</strong>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="summary-grid">
            <div class="summary-item">
                <h4><i class="bi bi-lightning-charge me-2"></i>Thanh toán VNPay</h4>
                <p class="text-secondary">Thanh toán trực tuyến an toàn, hỗ trợ hầu hết các ngân hàng nội địa.</p>
                <form th:action="@{/payments/vnpay/create}" method="post" class="d-grid gap-3">
                    <input type="hidden" name="orderId" th:value="${order.id}"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn-primary justify-content-center">
                        <i class="bi bi-shield-check"></i> Thanh toán qua VNPay
                    </button>
                </form>
            </div>
            <div class="summary-item">
                <h4><i class="bi bi-cash-stack me-2"></i>Thanh toán COD</h4>
                <p class="text-secondary">Trả tiền mặt khi nhận hàng. Vui lòng chuẩn bị số tiền đúng với giá trị đơn hàng.</p>
                <form th:action="@{/payments/cod/create}" method="post" class="d-grid gap-3">
                    <input type="hidden" name="orderId" th:value="${order.id}"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn-secondary justify-content-center">
                        <i class="bi bi-bag-check"></i> Xác nhận thanh toán COD
                    </button>
                </form>
            </div>
        </section>

        <div class="d-flex justify-content-center mt-5">
            <a class="btn-secondary" th:href="@{'/orders/' + ${order.id}}">
                <i class="bi bi-arrow-left"></i> Quay lại chi tiết đơn hàng
            </a>
        </div>
    </div>

    <div th:if="${order == null}" class="glass-card text-center">
        <div class="avatar-ring mx-auto mb-3 text-danger">
            <i class="bi bi-emoji-frown"></i>
        </div>
        <h2>Không tìm thấy đơn hàng</h2>
        <p class="text-secondary">Đơn hàng bạn yêu cầu không tồn tại hoặc đã bị xoá.</p>
        <a class="btn-primary mt-3" href="/orders/my">
            <i class="bi bi-arrow-left"></i> Quay lại đơn của tôi
        </a>
    </div>
</main>
</body>
</html>
